<!DOCTYPE html>
<html>
<head>
<title>sql2table</title>

<script src="lib/jquery-3.1.1.min.js"></script>

<style>
table {
  border-collapse: collapse;
}
table.resultTable th{ border:1px solid black; }
table.resultTable td{ border:1px solid black; }
.hidden{ display:none; }
.highlight{
	background-color: #ced1ff;	
}
.cellOn{
	font-style: italic;	
	color:red;
}
.popupOn{
	display: block !important;
}
.popupOff{
	display: none !important;
}
#popupTrackerMenu{
	background-color: #34dbca;
	opacity: .8;
	width: 7em;
	height:8em;
	position:absolute;
	top:10px;
	left:50px;
	border-bottom-left-radius: .5em;
	border-bottom-right-radius: .5em;
	display: none;
}
#popupTrackerMenu:hover{
	opacity: 1;
}
ul.plainMenu{
	list-style-type:none;
	padding: 1em;
	margin:0;
}
ul.plainMenu li{
	width:100%;
}
input.popupMenuBtn{
		width:100%;	
    border: none;
    color: #fff;

    text-align: center;
    text-decoration: none;
    display: inline-block;
    cursor: pointer;
}
.bgGreen{
	background-color: #54ba25;
}
.bgBlue{
	background-color: #1a8899;
}
.bgRed{
	background-color: #991a59;
}
.bgGray{
	background-color: #3e3a42;
}

input.popupMenuBtn:hover{
	-webkit-transition-duration: 0.2s; /* Safari */
    transition-duration: 0.2s;
	 	background-color: #fff; /* Green */
    color: #000;
}



</style>
</head>
<body>

<div>

<input type="text" class="csvText" style="width:100%">
<input type="button" class="btnConvert" value="Convert">
<input type="file" id="fileinput" class="fileinput">

</div> 
<div class="tableArea">
	<form class="tableForm">
		<table class="resultTable"><tr class="hiddenEnd"></tr></table>
	</form>
</div>
<span id="popupTrackerMenu">
	<ul class="plainMenu">
		<li><input id="popupEditBtn" class="popupMenuBtn bgGreen" type="button" value="Edit Cell"><input id="popupEditText" class="hidden" type="text" name=""></li>
		<li><input id="popupAddBtn" class="popupMenuBtn bgBlue" type="button" value="Add Cell"></li>
		<li><input id="popupDeleteBtn" class="popupMenuBtn bgRed" type="button" value="Delete Cell"></li>
		<hr>
		<li><input id="popupCloseBtn" class="popupMenuBtn bgGray" type="button" value="Close"></li>
	</ul>
</span>
<div id="scroll"></div>
<script>
// ==================== jQuery ==================

/**string of h1,h2,'h3,33',h4 => array of [h1,h2,'h3,33',h4]*/
function stringOfColumns2array(string,delim=','){
	var arr = string.split(delim); var arr2 = []; var strBuilder = "";
	for(var i=0;i<arr.length;i++){
		if(arr[i].startsWith("'")){
			if(arr[i].endsWith("'") && arr[i].length>1){ arr2.push(arr[i]); }			
			else{	strBuilder=arr[i]; i++; if(i<arr.length){ strBuilder+=delim+arr[i];}	
				while(!strBuilder.endsWith("'") && ++i<arr.length){ strBuilder+=delim+arr[i]; }
				arr2.push(strBuilder); strBuilder="";
			}
		}
		else if(arr[i].startsWith("to_timestamp(")){ strBuilder+=arr[i];
			while(!strBuilder.endsWith(")") && ++i<arr.length){ strBuilder+=delim+arr[i]; }
			arr2.push(strBuilder); strBuilder=""; 
		}
		else{ arr2.push(arr[i]); }
	}
	return arr2;
}
/**array of [h1,h2,'h3,33',h4] => html of <th>h1</th><th>h2</th><th>'h3,33'</th><th>h4</th>  or <td>h1</td><td>h2</td><td>'h3,33'</td><td>h4</td> */
function arrayOfColumns2cells(array,type='r',dataId){
	var htm="";	switch(type){case 'h': for(var i=0;i<array.length;i++){htm+='<th data-id='+dataId+' data-cid='+i+'>'+array[i]+'</th>'};break;
							 case 'r': for(var i=0;i<array.length;i++){htm+='<td data-id='+dataId+' data-cid='+i+'>'+array[i]+'</td>'};break; 
							 default:break;}	
	return htm;
}
/**string of h1,h2,'h3,33',h4 => html */
function stringOfColumns2htm(stringOfColumns, type='r',dataId){ return arrayOfColumns2cells(stringOfColumns2array(stringOfColumns),type,dataId); }
function cleanBracketString(string){
	var stringBuilder=string.toString().trim();	stringBuilder=stringBuilder.replace(/[()]/g, "");
 	return stringBuilder.toString().trim();
}
function log(str){ console.log(str); }
function hasClass(element, cls) {
    return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
}
/**
assume that always parsing complete sql statement(s)
Usage: sqlParser.parse(sqlstring) -> get properties: sqlParser.sqlCommand (others like: tableName,hColumns,rColumns)*/
function sqlParser(){ 
	this.insertPtn = /^INSERT\s{1,}INTO\s.*[)]\s*VALUES\s*[(].*$/i;
	// can add updatePtn, deletePtn
  this.commandInsertHeadPtn=/^INSERT\sINTO\s*/i;
  this.tableNamePtn=/^[^,]+[(]/g;
  this.commandMidValuesPtn = /[)]\s*VALUES\s*[(]/gi;
  this.commandEndPtn = /[)][;]\s*$/g;
  this.sqlCommand = "";
  this.tableName = "";
  this.hColumns = "";
  this.rColumns = "";
  this.id=0;
  this.state=0; //0-init, 1-ready/prepared, 2-used    need to be 1 to do next job, 3-error, cannot getHtml(), getArray(), getJson()

  this.init = function(){
  	this.id=0;
  	this.sqlCommand = "";
	  this.tableName = "";
	  this.hColumns = "";
	  this.rColumns = "";
  	this.state=0;
  }
  this.prepare = function(){ 
	  this.tableName = "";
	  this.hColumns = "";
	  this.rColumns = "";
	  this.state=1;
  }
  this.increaseId = function(){ this.id++; }
  this.parse = function(sqlString){
  	this.prepare();
  	if(this.state>=2){ return null; }

    if(this.insertPtn.test(sqlString)){
    	this.increaseId();
	  	this.sqlCommand = sqlString.match(this.commandInsertHeadPtn);
	  	var tableName_NRest = sqlString.substring(this.sqlCommand.toString().length);
	  	this.tableName = tableName_NRest.match(this.tableNamePtn);

	  	var hColumns_NRest = tableName_NRest.substring(this.tableName.toString().length);
	  	this.commandMidValuesPtn.test(hColumns_NRest)
	  	this.hColumns = hColumns_NRest.substring(0,this.commandMidValuesPtn.lastIndex)
	  	this.rColumns = hColumns_NRest.substring(this.commandMidValuesPtn.lastIndex)

	  	var lenToDump = this.hColumns.match(this.commandMidValuesPtn).toString().length
	  	var hlen = this.hColumns.toString().length;
	  	this.hColumns = this.hColumns.toString().substring(0, hlen-lenToDump).trim();        	

	  	var lenToDump = this.rColumns.match(this.commandEndPtn).pop().toString().length;
	  	var rlen = this.rColumns.toString().length;
	  	this.rColumns = this.rColumns.toString().substring(0,rlen-lenToDump).trim();

	  	this.sqlCommand = this.sqlCommand.toString().trim();
	  	this.tableName = cleanBracketString(this.tableName); 

	  	this.state=2;  	
	  	return this.state;
  	} else { /*error state*/this.state=3; return this.state; }
      // can add updatePtn, deletePtn  	
  }
  this.getHtml = function(type='r'){
  	if(this.state==3){return null;}
  	var htm; var idx =this.id+""+type;
  	switch(type){
  		case 'r': htm="<tr data-id="+idx+" class='responsable'><td data-id="+idx+" data-cid='-2' class='tbcomm'>"+this.sqlCommand+"</td><td data-id="+idx+" data-cid='-1' class='tbname hidden'>"+this.tableName+"</td>"+stringOfColumns2htm(this.rColumns,type,idx)+"</tr>";break;
  		case 'h': htm="<tr data-id="+idx+" class='responsable'><th data-id="+idx+" data-cid='-2' class='hidden'>"+this.sqlCommand+"</th><th data-id="+idx+" data-cid='-1' class='tbname'>"+this.tableName+"</th>"+stringOfColumns2htm(this.hColumns,type,idx)+"</tr>";break;
  		default:break;
  	}
  	return htm;
  }
  this.getArray = function(type='r'){
  	if(this.state==3){return null;}
  	var arr;
  	switch(type){
  		case 'r': arr=stringOfColumns2array(this.rColumns,type);break;
  		case 'h': arr=stringOfColumns2array(this.hColumns,type);break;
  		default:break;
  	}
  	return arr;
  }
  this.getJson = function(type="hr"){
  	if(this.state==3){return null;}
  	var json;
  	switch(type){
  		case "hr": json={"id":this.id,"hArray":this.getArray('h'),"rArray":this.getArray('r')};break;
  		default:break;
  	}
  	return json;
  }
}// ***endOf sqlParser

function sqlRecorder(){
	this.records=[];
	this.init = function(){ this.records=[]; }
	this.add = function(json){ // json shoud be from sqlParser.getJson()
		if(json){this.records.push(json);}
	}
	this.get = function(id=null){
		if(!id){   return this.records;   } else {   var index = this.getIndexById(id);if(index){return this.records[index];}else{return null;}   }
	}
	this.getIndexById = function(id){
		for(var i=0;i<this.records.length;i++){  if(this.records[i].id==id){return i;}  };return null;
	}
	this.getLast = function(){ return this.records[this.records.length-1]; }
} // ***endOf sqlRecorder

/**data-id for each row/tr is unique: 3h,3r*/
function getTrByAtt(attrName='data-id',attrValue){
	var rows=document.getElementsByTagName('TR');
	for(var i=0;i<rows.length;i++){ if(rows[i].getAttribute(attrName)==attrValue) return rows[i] }
	return null;
}



  
// =========================================== main ======================================
$.noConflict();


jQuery( document ).ready(function( $ ) {
// 1
  var parser = new sqlParser();
  var recorder = new sqlRecorder();
  var tracker = new cellTracker();
  var lines;
// 2 ?
function readSingleFile(evt) {
    //Retrieve the first (and only!) File from the FileList object
    var f = evt.target.files[0];     
    if (f) {
      var r = new FileReader();
      lines = "";
      var loaded=[];
      var ignores=[];
      r.onload = function(e) {   
	      var content = e.target.result;   //f.name,f.type,f.size
        lines = content.split(/[\r\n]+/g); // tolerate both Windows and Unix linebreaks
	      if(lines.length >0){
	      	for(var i=0;i<lines.length;i++){
	      		var feedback = parser.parse(lines[i]);
	      		if(feedback==2){
	      			recorder.add(parser.getJson());
				      // need to know if same table name exists -> only append parser.getHtml('r') if exists
				      $('tr.hiddenEnd').before(parser.getHtml('h'));
				      $('tr.hiddenEnd').before(parser.getHtml('r'));
				      loaded.push(i+1);
	      		}else{
	      			//log("line#"+ (i+1) +" ignored");
	      			ignores.push(i+1);
	      		}
	      	}
	      	if(ignores.length > 0){
	      		log("Loaded "+loaded.length + "/"+ lines.length + " : "+ loaded+"\n"+
	      			"Ignored "+ignores.length + "/"+ lines.length + " : "+ ignores)
	      	}
	      /*	lines.forEach(function(line) {
	      		var feedback = parser.parse(line);
	      		if(feedback==2){
	      			recorder.add(parser.getJson());
				      // need to know if same table name exists -> only append parser.getHtml('r') if exists
				      $('tr.hiddenEnd').before(parser.getHtml('h'));
				      $('tr.hiddenEnd').before(parser.getHtml('r'));
				      line="";

	      		}else{
	      			log("a line ignored");
	      		}
	      	});*/
	      }
      }
      r.readAsText(f);
      //return lines;
      log('File loaded');
    } else {     	
      alert("Failed to load file");
      return null;
    }
  }

// 3 events 
	if (window.File && window.FileReader && window.FileList && window.Blob) {
		  //do your stuff!
		  document.getElementById('fileinput').addEventListener('change', readSingleFile, false);
		} else {
			$('input.fileinput').css("text-decoration:line-through")
		  alert('The File APIs are not fully supported by your browser.');
		}

  //.containsExact("sometext") use like .text("sometext")
  $.expr[":"].containsExact = function (obj, index, meta, stack) {
      return (obj.textContent || obj.innerText || $(obj).text() || "") == meta[3];
  };

// 4 UI actions
  //var cell = new CellFinder();
  $('input.btnConvert').click(function(){ // assume that always parsing complete sql statement(s)
      var $inputField = $('input.csvText');
      var feedback = parser.parse($inputField.val());
      if(feedback==2){  //3-err, 0-init, 1-prepare
      	recorder.add(parser.getJson());
	      // need to know if same table name exists -> only append parser.getHtml('r') if exists
	      $('tr.hiddenEnd').before(parser.getHtml('h'));
	      $('tr.hiddenEnd').before(parser.getHtml('r'));

	      $inputField.val("");
      }
      
  });// ***endOf btnConvert.click

  // *** endof btnUpload.click
  // event
	

  $( document ).on( 'mouseover', 'tr.responsable', function(event) {   $(this).addClass('highlight')	})
  						.on( 'mouseleave', 'tr.responsable', function(event) {   $(this).removeClass('highlight')	})
  						.on( 'dblclick', 'tr.responsable>td,th', function(event){
  							var d_id = $(this).attr('data-id')
  							var d_cid = $(this).attr('data-cid');

  							tracker.trackCell(d_id, d_cid)
  							log("cell@ "+tracker.x+","+tracker.y+","+tracker.w+","+tracker.h);
  						});
  window.onscroll = function() {
  	$('#scroll').text("screen.height="+document.body.scrollLeft+", documentElement.scrollLeft="+document.documentElement.scrollLeft);
  };


});
// ======================================= end of main ============================================
function cellTracker(){

	this.cell;
	this.d_id;
	this.d_cid;

	this.onClass = "cellOn"; // to be add to cell to show tracked/selected
	this.x;
	this.y;
	this.w;
	this.h;
	this.text;

	this.isOpen;
	this.keepOpen=false; // when editing/inserting/deleting, keepOpen=true, and shouldn't be interupted. only
	this.close = function(){
		this.keepOpen = false;
		this.showHideMenue();
	}
	this.cellOnOff = function(isToBeOn){
		if(this.keepOpen){ return null; }
		if(!this.cell){ return null; }

		if(isToBeOn){
			if(!this.cell.classList.contains(this.onClass)) {this.cell.classList.add(this.onClass);}
			this.isOpen=true;
		}else{
			if(this.cell.classList.contains(this.onClass)) {this.cell.classList.remove(this.onClass);}
			this.isOpen=false;
		}		
	}
	this.popupOnOff = function(isToBeOn){
		if(this.keepOpen){ return null; }
		if(!this.cell){ return null; }
		var menu=document.getElementById("popupTrackerMenu");
		if(!menu){ return null; }

		if(isToBeOn){
			if(!menu.classList.contains("popupOn")){menu.classList.add('popupOn');}
			menu.style.left = this.x+document.documentElement.scrollLeft+'px';
			menu.style.top = this.y+this.h+document.documentElement.scrollTop+'px';
			//$(window).height(); 
		}else{
			if(menu.classList.contains("popupOn")){menu.classList.remove('popupOn');}
		}		
	}

	this.reset = function(){
		/*this.cellOnOff(false);*/
		this.x="";
		this.y="";
		this.w="";
		this.h="";
		this.text="";
		this.cell="";
		this.d_id="";
		this.d_cid="";
	}
	this.trackCell = function(d_id,d_cid){
		
		if(this.keepOpen){ return null; }

		this.cellOnOff(false);
		this.popupOnOff(false);
		if(this.d_id == d_id && this.d_cid == d_cid){
			this.reset();

		}else{

			this.reset();
			this.d_id=d_id;
			this.d_cid=d_cid;

			var cells = getTrByAtt('data-id',this.d_id).childNodes;
			for(var i=0;i<cells.length;i++){
				if(cells[i].getAttribute('data-cid')==this.d_cid) {
					var rect = cells[i].getBoundingClientRect();
					this.x=rect.left;
					this.y=rect.top;
					this.w=rect.right-rect.left;
					this.h=rect.bottom-rect.top;
					this.text=cells[i].innerText;				
					this.cell=cells[i];
					i=+cells.length
				}
			}
			if(this.cell){ this.cellOnOff(true); this.popupOnOff(true); }
		}		
	}
}




</script>
</body>
</html>