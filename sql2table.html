<!DOCTYPE html>
<html>
<head>
<title>sql2table</title>

<script src="lib/jquery-3.1.1.min.js"></script>

<style>
table {
  border-collapse: collapse;
}
table.resultTable th{ border:1px solid black; }
table.resultTable td{ border:1px solid black; }
.hidden{ display:none; }
.highlight{
	background-color: #ced1ff;	
}
.trackMarker{
	font-style: italic;	
	color:red;
}
.popupOn{
	display: block !important;
}
.popupOff{
	display: none !important;
}
#popupTrackerMenu{
	background-color: #34dbca;
	opacity: .8;
	width: 7em;
	height:8em;
	position: absolute;
	top:10px;
	left:50px;
	border-radius: 1em;
	display: none;
}
#popupTrackerMenu:hover{
	opacity: 1;
}
ul.plainMenu{
	list-style-type:none;
	padding: 1em;
	margin:0;
}
ul.plainMenu li{
	width:100%;
}
input.popupMenuBtn{
		width:100%;	
    border: none;
    color: #fff;

    text-align: center;
    text-decoration: none;
    display: inline-block;
    cursor: pointer;
}
.bgGreen{
	background-color: #54ba25;
}
.bgBlue{
	background-color: #1a8899;
}
.bgRed{
	background-color: #991a59;
}
.bgGray{
	background-color: #3e3a42;
}

input.popupMenuBtn:hover{
	-webkit-transition-duration: 0.2s; /* Safari */
    transition-duration: 0.2s;
	 	background-color: #fff; /* Green */
    color: #000;
}



</style>
</head>
<body>

<div>

<input type="text" class="csvText" style="width:100%">
<input type="button" class="btnConvert" value="Convert">
</div> 
<div class="tableArea">
	<form class="tableForm">
		<table class="resultTable"><tr class="hiddenEnd"></tr></table>
	</form>
</div>
<span id="popupTrackerMenu">
	<ul class="plainMenu">
		<li><input id="popupEditBtn" class="popupMenuBtn bgGreen" type="button" value="Edit Cell"><input id="popupEditText" class="hidden" type="text" name=""></li>
		<li><input id="popupAddBtn" class="popupMenuBtn bgBlue" type="button" value="Add Cell"></li>
		<li><input id="popupDeleteBtn" class="popupMenuBtn bgRed" type="button" value="Delete Cell"></li>
		<hr>
		<li><input id="popupCloseBtn" class="popupMenuBtn bgGray" type="button" value="Close"></li>
	</ul>
</span>
<script>
// ==================== jQuery ==================




function uiTracker(){
	this.now;
	this.marker = "trackMarker";
	this.eraseMarker = function(ele,x,y){ if(ele){ele.className="";} showHide_popupTrackerMenu(false,x,y);} 	
	this.addMarker = function(ele,x,y){ if(ele){ele.className=this.marker; showHide_popupTrackerMenu(true,x,y)}} 	

	this.track = function(ele,x,y){
		//if(hasClass(ele,this.marker)){ this.eraseMarker(ele,x,y); }
		if(ele.classList.contains(this.marker)){ this.eraseMarker(ele,x,y); }
		else{ this.eraseMarker(this.now,x,y);this.now=ele;this.addMarker(this.now,x,y); }		
	}
}

function showHide_popupTrackerMenu(isOn,x,y){	
	var e=document.getElementById("popupTrackerMenu");
	if(!e){return null;}
	if(isOn){
		log("turn on")
		/*if(hasClass(e,'popupOff')){e.classList.remove('popupOff');}*/
		//if(!hasClass(e,'popupOn')){e.classList.add('popupOn');}
		if(!e.classList.contains("popupOn")){e.classList.add('popupOn');}
		e.style.left = x+'px';
		e.style.top = y+'px';
	}
	else{		
		log("turn off")
		//if(hasClass(e,'popupOn')){e.classList.remove('popupOn');}
		if(e.classList.contains("popupOn")){e.classList.remove('popupOn');}

		/*if(!hasClass(e,'popupOff')){e.classList.add('popupOff');}*/
	}

}


/**string of h1,h2,'h3,33',h4 => array of [h1,h2,'h3,33',h4]*/
function stringOfColumns2array(string,delim=','){
	var arr = string.split(delim); var arr2 = []; var strBuilder = "";
	for(var i=0;i<arr.length;i++){
		if(arr[i].startsWith("'")){
			if(arr[i].endsWith("'") && arr[i].length>1){ arr2.push(arr[i]); }			
			else{	strBuilder=arr[i]; i++; if(i<arr.length){ strBuilder+=delim+arr[i];}	
				while(!strBuilder.endsWith("'") && ++i<arr.length){ strBuilder+=delim+arr[i]; }
				arr2.push(strBuilder); strBuilder="";
			}
		}
		else if(arr[i].startsWith("to_timestamp(")){ strBuilder+=arr[i];
			while(!strBuilder.endsWith(")") && ++i<arr.length){ strBuilder+=delim+arr[i]; }
			arr2.push(strBuilder); strBuilder=""; 
		}
		else{ arr2.push(arr[i]); }
	}
	return arr2;
}
/**array of [h1,h2,'h3,33',h4] => html of <th>h1</th><th>h2</th><th>'h3,33'</th><th>h4</th>  or <td>h1</td><td>h2</td><td>'h3,33'</td><td>h4</td> */
function arrayOfColumns2cells(array,type='r'){
	var htm="";	switch(type){case 'h': for(var i=0;i<array.length;i++){htm+='<th data-cid='+i+'>'+array[i]+'</th>'};break;
							 case 'r': for(var i=0;i<array.length;i++){htm+='<td data-cid='+i+'>'+array[i]+'</td>'};break; 
							 default:break;}	
	return htm;
}
/**string of h1,h2,'h3,33',h4 => html */
function stringOfColumns2htm(stringOfColumns, type='r'){ return arrayOfColumns2cells(stringOfColumns2array(stringOfColumns),type); }
function cleanBracketString(string){
	var stringBuilder=string.toString().trim();	stringBuilder=stringBuilder.replace(/[()]/g, "");
 	return stringBuilder.toString().trim();
}
function log(str){ console.log(str); }
function hasClass(element, cls) {
    return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
}
/**
assume that always parsing complete sql statement(s)
Usage: sqlParser.init() -> sqlParser.parse(sqlstring) -> get properties: sqlParser.sqlCommand (others like: tableName,hColumns,rColumns)*/
function sqlParser(){ 
	this.insertPtn = /^INSERT\s{1,}INTO\s.*[)]\s*VALUES\s*[(].*$/i;
	// can add updatePtn, deletePtn
  this.commandInsertHeadPtn=/^INSERT\sINTO\s*/i;
  this.tableNamePtn=/^[^,]+[(]/g;
  this.commandMidValuesPtn = /[)]\s*VALUES\s*[(]/gi;
  this.commandEndPtn = /[)][;]\s*$/g;
  this.sqlCommand = "";
  this.tableName = "";
  this.hColumns = "";
  this.rColumns = "";
  this.id=0;
  this.state=0; //0-init, 1-ready/prepared, 2-used    need to be 1 to do next job, 3-error, cannot getHtml(), getArray(), getJson()

  this.init = function(){
  	this.id=0;
  	this.sqlCommand = "";
	  this.tableName = "";
	  this.hColumns = "";
	  this.rColumns = "";
  	this.state=0;
  }
  this.prepare = function(){
  	this.sqlCommand = "";
	  this.tableName = "";
	  this.hColumns = "";
	  this.rColumns = "";
	  this.state=1;
  }
  this.increaseId = function(){ this.id++; }
  this.parse = function(sqlString){
  	//log(this.state);
  	if(this.state>=2){ return null; }

    if(this.insertPtn.test(sqlString)){
    	this.increaseId();
	  	this.sqlCommand = sqlString.match(this.commandInsertHeadPtn);
	  	var tableName_NRest = sqlString.substring(this.sqlCommand.toString().length);
	  	this.tableName = tableName_NRest.match(this.tableNamePtn);

	  	var hColumns_NRest = tableName_NRest.substring(this.tableName.toString().length);
	  	this.commandMidValuesPtn.test(hColumns_NRest)
	  	this.hColumns = hColumns_NRest.substring(0,this.commandMidValuesPtn.lastIndex)
	  	this.rColumns = hColumns_NRest.substring(this.commandMidValuesPtn.lastIndex)

	  	var lenToDump = this.hColumns.match(this.commandMidValuesPtn).toString().length
	  	var hlen = this.hColumns.toString().length;
	  	this.hColumns = this.hColumns.toString().substring(0, hlen-lenToDump).trim();        	

	  	var lenToDump = this.rColumns.match(this.commandEndPtn).pop().toString().length;
	  	var rlen = this.rColumns.toString().length;
	  	this.rColumns = this.rColumns.toString().substring(0,rlen-lenToDump).trim();

	  	this.sqlCommand = this.sqlCommand.toString().trim();
	  	this.tableName = cleanBracketString(this.tableName); 

	  	this.state=2;  	
  	} else { this.state=3; }
      // can add updatePtn, deletePtn  	
  }
  this.getHtml = function(type='r'){
  	if(this.state==3){return null;}
  	var htm;
  	switch(type){
  		case 'r': htm="<tr class='responsable' data-id="+this.id+"><td data-cid='-2' class='tbcomm'>"+this.sqlCommand+"</td><td data-cid='-1' class='tbname hidden'>"+this.tableName+"</td>"+stringOfColumns2htm(this.rColumns,type)+"</tr>";break;
  		case 'h': htm="<tr class='responsable' data-id="+this.id+"><th data-cid='-2' class='hidden'>"+this.sqlCommand+"</th><th data-cid='-1' class='tbname'>"+this.tableName+"</th>"+stringOfColumns2htm(this.hColumns,type)+"</tr>";break;
  		default:break;
  	}
  	return htm;
  }
  this.getArray = function(type='r'){
  	if(this.state==3){return null;}
  	var arr;
  	switch(type){
  		case 'r': arr=stringOfColumns2array(this.rColumns,type);break;
  		case 'h': arr=stringOfColumns2array(this.hColumns,type);break;
  		default:break;
  	}
  	return arr;
  }
  this.getJson = function(type="hr"){
  	if(this.state==3){return null;}
  	var json;
  	switch(type){
  		case "hr": json={"id":this.id,"hArray":this.getArray('h'),"rArray":this.getArray('r')};break;
  		default:break;
  	}
  	return json;
  }
}// ***endOf sqlParser

function sqlRecorder(){
	this.records=[];
	this.init = function(){ this.records=[]; }
	this.add = function(json){ // json shoud be from sqlParser.getJson()
		if(json){this.records.push(json);}
	}
	this.get = function(id=null){
		if(!id){   return this.records;   } else {   var index = this.getIndexById(id);if(index){return this.records[index];}else{return null;}   }
	}
	this.getIndexById = function(id){
		for(var i=0;i<this.records.length;i++){  if(this.records[i].id==id){return i;}  };return null;
	}
	this.getLast = function(){ return this.records[this.records.length-1]; }
} // ***endOf sqlRecorder


// =========================================== main ======================================
$.noConflict();


jQuery( document ).ready(function( $ ) {
  //.containsExact("sometext") use like .text("sometext")
  $.expr[":"].containsExact = function (obj, index, meta, stack) {
      return (obj.textContent || obj.innerText || $(obj).text() || "") == meta[3];
  };

  var parser = new sqlParser();
  var recorder = new sqlRecorder();
  var tracker = new uiTracker();
  var trackId,trackCid;
  $('input.btnConvert').click(function(){ // assume that always parsing complete sql statement(s)
      var txt = $('input.csvText').val();
      parser.parse(txt);
      recorder.add(parser.getJson());
      // need to know if same table name exists -> only append parser.getHtml('r') if exists
      $('tr.hiddenEnd').before(parser.getHtml('h'));
      $('tr.hiddenEnd').before(parser.getHtml('r'));
			parser.prepare();
      //log(recorder.getLast());

  });// ***endOf btnConvert.click
  // event

  $( document ).on( 'mouseover', 'tr.responsable', function(event) {   $(this).addClass('highlight')	})
  						.on( 'mouseleave', 'tr.responsable', function(event) {   $(this).removeClass('highlight')	})
  						.on( 'dblclick', 'tr.responsable', function(event) {   
  							trackId = $(this).attr('data-id');							
  						})
  						.on( 'dblclick', 'tr.responsable>td,th', function(event){
  							trackCid = $(this).attr('data-cid');
  							log("id,cid = "+trackId+","+trackCid);
  							var px=event.pageX;
  							var py=event.pageY;
  							//var element = document.elementFromPoint(px, py);
  							//tracker.track(element,px,py);
  							var trackTag = event.target.tagName;
  							var trackText = event.target.innerText;
  							
  							log(getCell(trackTag, trackId, trackCid));
  						})


});
function getCell(tag='TD',id,cid){
	this.x;
	this.y;
	this.popX;
	this.popY;
	this.text;
	// 1 get row by data-id
	// 2 get cell by data-cid
	var cells = document.getElementsByTagName(tag);
	log(cells.length)
}



</script>
</body>
</html>