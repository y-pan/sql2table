<!DOCTYPE html>
<html>
<head>
<title>sql2table</title>

<script src="lib/jquery-3.1.1.min.js"></script>

<style>
table {
  border-collapse: collapse;
}
table.resultTable th{ border:1px solid black; }
table.resultTable td{ border:1px solid black; }
.hidden{ display:none; }
.highlight{
	background-color: #ced1ff;	
}
.trackMarker{
	font-style: italic;
	font-weight: bold;
	color:red;
}
</style>
</head>
<body>

<div>

<input type="text" class="csvText" style="width:100%">
<input type="button" class="btnConvert" value="Convert">
</div> 
<div class="tableArea">
	<form class="tableForm">
		<table class="resultTable"><tr class="hiddenEnd"></tr></table>
	</form>
</div>
<script>
// ==================== jQuery ==================



/**string of h1,h2,'h3,33',h4 => array of [h1,h2,'h3,33',h4]*/
function stringOfColumns2array(string,delim=','){
	var arr = string.split(delim); var arr2 = []; var strBuilder = "";
	for(var i=0;i<arr.length;i++){
		if(arr[i].startsWith("'")){
			if(arr[i].endsWith("'") && arr[i].length>1){ arr2.push(arr[i]); }			
			else{	strBuilder=arr[i]; i++; if(i<arr.length){ strBuilder+=delim+arr[i];}	
				while(!strBuilder.endsWith("'") && ++i<arr.length){ strBuilder+=delim+arr[i]; }
				arr2.push(strBuilder); strBuilder="";
			}
		}
		else if(arr[i].startsWith("to_timestamp(")){ strBuilder+=arr[i];
			while(!strBuilder.endsWith(")") && ++i<arr.length){ strBuilder+=delim+arr[i]; }
			arr2.push(strBuilder); strBuilder=""; 
		}
		else{ arr2.push(arr[i]); }
	}
	return arr2;
}
/**array of [h1,h2,'h3,33',h4] => html of <th>h1</th><th>h2</th><th>'h3,33'</th><th>h4</th>  or <td>h1</td><td>h2</td><td>'h3,33'</td><td>h4</td> */
function arrayOfColumns2cells(array,type='r'){
	var htm="";	switch(type){case 'h': for(var i=0;i<array.length;i++){htm+='<th>'+array[i]+'</th>'};break;
							 case 'r': for(var i=0;i<array.length;i++){htm+='<td>'+array[i]+'</td>'};break; 
							 default:break;}	
	return htm;
}
/**string of h1,h2,'h3,33',h4 => html */
function stringOfColumns2htm(stringOfColumns, type='r'){ return arrayOfColumns2cells(stringOfColumns2array(stringOfColumns),type); }
function cleanBracketString(string){
	var stringBuilder=string.toString().trim();	stringBuilder=stringBuilder.replace(/[()]/g, "");
 	return stringBuilder.toString().trim();
}
function log(str){ console.log(str); }
function hasClass(element, cls) {
    return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
}
/**
assume that always parsing complete sql statement(s)
Usage: sqlParser.init() -> sqlParser.parse(sqlstring) -> get properties: sqlParser.sqlCommand (others like: tableName,hColumns,rColumns)*/
function sqlParser(){ 
	this.insertPtn = /^INSERT\s{1,}INTO\s.*[)]\s*VALUES\s*[(].*$/i;
	// can add updatePtn, deletePtn
  this.commandInsertHeadPtn=/^INSERT\sINTO\s*/i;
  this.tableNamePtn=/^[^,]+[(]/g;
  this.commandMidValuesPtn = /[)]\s*VALUES\s*[(]/gi;
  this.commandEndPtn = /[)][;]\s*$/g;
  this.sqlCommand = "";
  this.tableName = "";
  this.hColumns = "";
  this.rColumns = "";
  this.id=0;
  this.state=0; //0-init, 1-ready/prepared, 2-used    need to be 1 to do next job, 3-error, cannot getHtml(), getArray(), getJson()

  this.init = function(){
  	this.id=0;
  	this.sqlCommand = "";
	  this.tableName = "";
	  this.hColumns = "";
	  this.rColumns = "";
  	this.state=0;
  }
  this.prepare = function(){
  	this.sqlCommand = "";
	  this.tableName = "";
	  this.hColumns = "";
	  this.rColumns = "";
	  this.state=1;
  }
  this.increaseId = function(){ this.id++; }
  this.parse = function(sqlString){
  	log(this.state);
  	if(this.state>=2){ return null; }

    if(this.insertPtn.test(sqlString)){
    	this.increaseId();
	  	this.sqlCommand = sqlString.match(this.commandInsertHeadPtn);
	  	var tableName_NRest = sqlString.substring(this.sqlCommand.toString().length);
	  	this.tableName = tableName_NRest.match(this.tableNamePtn);

	  	var hColumns_NRest = tableName_NRest.substring(this.tableName.toString().length);
	  	this.commandMidValuesPtn.test(hColumns_NRest)
	  	this.hColumns = hColumns_NRest.substring(0,this.commandMidValuesPtn.lastIndex)
	  	this.rColumns = hColumns_NRest.substring(this.commandMidValuesPtn.lastIndex)

	  	var lenToDump = this.hColumns.match(this.commandMidValuesPtn).toString().length
	  	var hlen = this.hColumns.toString().length;
	  	this.hColumns = this.hColumns.toString().substring(0, hlen-lenToDump).trim();        	

	  	var lenToDump = this.rColumns.match(this.commandEndPtn).pop().toString().length;
	  	var rlen = this.rColumns.toString().length;
	  	this.rColumns = this.rColumns.toString().substring(0,rlen-lenToDump).trim();

	  	this.sqlCommand = this.sqlCommand.toString().trim();
	  	this.tableName = cleanBracketString(this.tableName); 

	  	this.state=2;  	
  	} else { this.state=3; }
      // can add updatePtn, deletePtn  	
  }
  this.getHtml = function(type='r'){
  	if(this.state==3){return null;}
  	var htm;
  	switch(type){
  		case 'r': htm="<tr class='responsable' data-id="+this.id+"><td class='tbcomm'>"+this.sqlCommand+"</td><td class='tbname hidden'>"+this.tableName+"</td>"+stringOfColumns2htm(this.rColumns,type)+"</tr>";break;
  		case 'h': htm="<tr class='responsable' data-id="+this.id+"><th class='hidden'>"+this.sqlCommand+"</th><th class='tbname'>"+this.tableName+"</th>"+stringOfColumns2htm(this.hColumns,type)+"</tr>";break;
  		default:break;
  	}
  	return htm;
  }
  this.getArray = function(type='r'){
  	if(this.state==3){return null;}
  	var arr;
  	switch(type){
  		case 'r': arr=stringOfColumns2array(this.rColumns,type);break;
  		case 'h': arr=stringOfColumns2array(this.hColumns,type);break;
  		default:break;
  	}
  	return arr;
  }
  this.getJson = function(type="hr"){
  	if(this.state==3){return null;}
  	var json;
  	switch(type){
  		case "hr": json={"id":this.id,"hArray":this.getArray('h'),"rArray":this.getArray('r')};break;
  		default:break;
  	}
  	return json;
  }
}// ***endOf sqlParser

function sqlRecorder(){
	this.records=[];
	this.init = function(){ this.records=[]; }
	this.add = function(json){ // json shoud be from sqlParser.getJson()
		if(json){this.records.push(json);}
	}
	this.get = function(id=null){
		if(!id){   return this.records;   } else {   var index = this.getIndexById(id);if(index){return this.records[index];}else{return null;}   }
	}
	this.getIndexById = function(id){
		for(var i=0;i<this.records.length;i++){  if(this.records[i].id==id){return i;}  };return null;
	}
	this.getLast = function(){ return this.records[this.records.length-1]; }
} // ***endOf sqlRecorder

function uiTracker(){
	this.now;
	this.marker = "trackMarker";
	this.eraseMarker = function(ele){ if(ele){ele.className=""} } 	
	this.addMarker = function(ele){ if(ele){ele.className=this.marker} } 	

	this.track = function(ele){
		if(hasClass(ele,this.marker)){this.eraseMarker(ele)}
		else{this.eraseMarker(this.now);this.now=ele;this.addMarker(this.now);}		
	}
}

// =========================================== main ======================================
$.noConflict();


jQuery( document ).ready(function( $ ) {
  //.containsExact("sometext") use like .text("sometext")
  $.expr[":"].containsExact = function (obj, index, meta, stack) {
      return (obj.textContent || obj.innerText || $(obj).text() || "") == meta[3];
  };

  var parser = new sqlParser();
  var recorder = new sqlRecorder();
  var tracker = new uiTracker();
  $('input.btnConvert').click(function(){ // assume that always parsing complete sql statement(s)
      var txt = $('input.csvText').val();
      parser.parse(txt);
      recorder.add(parser.getJson());
      // need to know if same table name exists -> only append parser.getHtml('r') if exists
      $('tr.hiddenEnd').before(parser.getHtml('h'));
      $('tr.hiddenEnd').before(parser.getHtml('r'));
			parser.prepare();
      //log(recorder.getLast());

  });// ***endOf btnConvert.click
  // event
  $( document ).on( 'mouseover', 'tr.responsable', function(event) {   $(this).addClass('highlight')	})
  						.on( 'mouseleave', 'tr.responsable', function(event) {   $(this).removeClass('highlight')	})
  						.on( 'dblclick', 'tr.responsable', function(event) {   
  							var id = $(this).attr('data-id');
  							var tds = $(this).children();
  							var px=event.pageX;
  							var py=event.pageY;
  							var element = document.elementFromPoint(px, py);
  							tracker.track(element);
  							//var x = eventx
  							//var el = event.currentTarget;					

  							//log(id)//$(this).removeClass('highlight')	
  							//log(element);
  						})


});




</script>
</body>
</html>